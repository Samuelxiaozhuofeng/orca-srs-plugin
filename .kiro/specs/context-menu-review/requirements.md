# 需求文档

## 简介

本功能为虎鲸笔记 SRS 闪卡插件添加右键菜单复习功能。用户可以通过右键点击块来启动针对性的复习会话：
- 对于查询块：收集查询结果中带 #Card 标签的块进行复习
- 对于普通块：遍历该块的所有子块，收集带 #Card 标签的块进行复习

该功能支持重复复习模式，即卡片可以在同一会话中多次出现，不受常规复习队列的到期时间限制。

## 术语表

- **查询块（Query Block）**：虎鲸笔记中的特殊块类型，其 `_repr.type` 为 `"query"`，包含查询结果列表
- **普通块（Normal Block）**：非查询块的常规块
- **卡片块（Card Block）**：带有 `#Card` 或 `#card` 标签的块
- **重复复习模式（Repeat Review Mode）**：允许卡片在同一会话中多次复习，不更新 SRS 状态
- **SRS 状态**：间隔重复系统的记忆状态，包括稳定度、难度、间隔等
- **复习会话（Review Session）**：一次复习活动的上下文，包含待复习卡片队列

## 需求

### 需求 1

**用户故事：** 作为用户，我想通过右键菜单对查询块启动复习，以便快速复习查询结果中的卡片。

#### 验收标准

1. WHEN 用户右键点击一个查询块 THEN 系统 SHALL 在右键菜单中显示"复习此查询结果"选项
2. WHEN 用户选择"复习此查询结果"选项 THEN 系统 SHALL 从查询结果列表中收集所有带 #Card 标签的块
3. WHEN 系统收集到卡片块 THEN 系统 SHALL 将这些卡片转换为 ReviewCard 对象并启动复习会话
4. IF 查询结果中没有带 #Card 标签的块 THEN 系统 SHALL 显示提示消息"查询结果中没有找到卡片"

### 需求 2

**用户故事：** 作为用户，我想通过右键菜单对普通块启动复习，以便复习该块下所有子块中的卡片。

#### 验收标准

1. WHEN 用户右键点击一个普通块 THEN 系统 SHALL 在右键菜单中显示"复习子块卡片"选项
2. WHEN 用户选择"复习子块卡片"选项 THEN 系统 SHALL 递归遍历该块的所有子块
3. WHEN 系统遍历子块时 THEN 系统 SHALL 收集所有带 #Card 标签的块
4. WHEN 系统收集到卡片块 THEN 系统 SHALL 将这些卡片转换为 ReviewCard 对象并启动复习会话
5. IF 子块中没有带 #Card 标签的块 THEN 系统 SHALL 显示提示消息"子块中没有找到卡片"

### 需求 3

**用户故事：** 作为用户，我想在右键复习模式下重复复习卡片，以便加强记忆而不受到期时间限制。

#### 验收标准

1. WHEN 用户通过右键菜单启动复习会话 THEN 系统 SHALL 启用重复复习模式
2. WHILE 处于重复复习模式 THEN 系统 SHALL 允许用户对同一张卡片进行多次复习
3. WHILE 处于重复复习模式 THEN 系统 SHALL 在复习界面显示"重复复习"标识
4. WHEN 用户在重复复习模式下评分卡片 THEN 系统 SHALL 更新卡片的 SRS 状态
5. WHEN 用户完成一轮复习后 THEN 系统 SHALL 提供"再复习一轮"选项

### 需求 4

**用户故事：** 作为用户，我想要右键菜单选项根据块类型智能显示，以便获得清晰的操作指引。

#### 验收标准

1. WHEN 右键点击的块是查询块 THEN 系统 SHALL 显示"复习此查询结果"菜单项
2. WHEN 右键点击的块是普通块 THEN 系统 SHALL 显示"复习子块卡片"菜单项
3. WHEN 显示菜单项时 THEN 系统 SHALL 在菜单项旁显示预估的卡片数量
4. IF 预估卡片数量为零 THEN 系统 SHALL 将菜单项显示为禁用状态

### 需求 5

**用户故事：** 作为用户，我想要卡片收集支持多种卡片类型，以便复习所有类型的闪卡。

#### 验收标准

1. WHEN 系统收集卡片时 THEN 系统 SHALL 支持 Basic 卡片类型
2. WHEN 系统收集卡片时 THEN 系统 SHALL 支持 Cloze 填空卡片类型
3. WHEN 系统收集卡片时 THEN 系统 SHALL 支持 Direction 方向卡片类型
4. WHEN 收集 Cloze 卡片时 THEN 系统 SHALL 为每个填空编号生成独立的 ReviewCard
5. WHEN 收集 Direction 卡片时 THEN 系统 SHALL 根据方向类型生成相应的 ReviewCard
