# 记忆排期推送（IR Scheduling & Queue Push）记录

> 目的：把“什么时候到期（排期）”与“今天推送谁（队列）”这两件事讲清楚，并记录我们从 SuperMemo 概念得到的启发、当前实现细节与调试要点，方便后续排查“堆积（Lumpiness）”与调参。

## 0. 这份文档解决什么问题？

在渐进阅读（IR）里，用户经常会在同一次阅读中做出很多摘录（Extract）。如果这些摘录的第一次复习时间集中在 1～2 天内，会产生明显的心理压力（“那天会爆炸”）。

本项目目前的目标是：

- 当用户在**短时间内**为**同一个 Topic** 一口气做出很多 Extract（例如 10～20 个）时，第一次复习时间应**随机铺开**到更长窗口（例如 7 天，必要时可到 10～14 天后）。
- 用户可接受“晚一点也行”（阅读材料不必精确卡在遗忘临界点）。
- 只要别挤在 1～2 天里，不追求严格均匀分布。

## 1. 两个关键概念：排期 vs 推送

### 1.1 排期（Scheduling）

“排期”指系统把下一次到期时间写入块属性：

- `ir.intervalDays`：下一次间隔（天，允许小数）
- `ir.due`：下一次到期时间（Date）

排期属于“写入行为”，主要入口在：

- `src/srs/incrementalReadingStorage.ts`
  - `ensureIRState`
  - `updatePriority`
  - `markAsRead` / `markAsReadWithPriority`
  - `postpone`

### 1.2 推送（Queue Push）

“推送”指系统在“今天”把哪些卡片放入阅读面板队列（不一定会写回排期）。

- 入口：`src/srs/incrementalReadingCollector.ts`
  - 收集到期卡：`collectIRCardsFromBlocks`
  - 构建今日队列：`buildIRQueue`
  - “溢出推后”（按钮触发，写回排期）：`deferIROverflow` / `deferOverflowCards`

> 重点：打开面板/构建队列通常只是“展示”，不会自动修改 `ir.due`；真正写回发生在“用户动作”（已读/推后/调优先级）或“明确按钮”（溢出推后）。

## 2. SuperMemo 概念对照（我们借鉴什么，不等同复刻）

下述内容用于“理解方向”，不是逐行复刻 SuperMemo 的私有实现：

### 2.1 Random Dispersal（随机分散）

要点：允许间隔围绕“理论最优值”波动，从而减少同日堆积（lumpiness）。

对我们而言：Extract 属于阅读材料（Topic-like），时间精确性要求较低，可以接受更大的分散窗口。

### 2.2 Spread / Branch（分支分散）

要点：当你从同一篇材料（同一 Topic）提取出一批子内容，这批内容天然是同一分支（siblings）。

对我们而言：同一 Topic 下同一天产生的多个 Extract，应该有“排队延迟”，第 2 个、第 3 个……自然更晚出现，以避免扎堆。

### 2.3 Auto-Postpone（自动推迟）

要点：如果某天任务过载，保留高价值/高优先级的，低优先级自动推迟到未来。

对我们而言：这是削峰填谷的兜底（本项目也有“溢出推后”能力），但用户偏好是 **A：创建时就铺开**，因此我们把“分支分散”放在创建/初始化阶段完成大头。

## 3. 我们的优先级语义（避免与 SM 混淆）

本项目：

- `ir.priority`：0～100，**数值越大越优先**（越频繁、越靠前）
- 这与很多系统把“数字越小越重要”的习惯相反，调参和解释时需要注意。

## 4. 当前实现：从“基础间隔”到“最终到期”

### 4.1 基础间隔（Base Interval）

基础间隔只由 `cardType + ir.priority` 决定：

- `src/srs/incrementalReadingScheduler.ts#getBaseIntervalDays`
  - Topic：约 `14d → 2d`
  - Extract：约 `7d → 1d`

举例（优先级 50）：

- Extract 的基础间隔约为 `4` 天（便于后续理解示例）

### 4.2 分散抖动（Dispersal）：解决“同日结块”

实现：

- `src/srs/incrementalReadingDispersal.ts#computeDispersedIntervalDays`

核心做法：

1) 使用“按天稳定”的随机 seed（`blockId + localDayStart`），保证同一天重复触发不会反复变化。
2) 新卡（`readCount=0 && lastRead=null`）默认只向后分散，避免“过早复习”浪费效率。
3) 非新卡按比例 ± 分散，Extract 更大、Topic 更小。

### 4.3 新 Extract 的“分支排队延迟”（Sibling Queue Delay）

这是为了解决“同一 Topic 下同一天做 10～20 个 Extract 仍然集中”的问题。

实现：

- `src/srs/incrementalReadingStorage.ts#computeNewExtractQueueDelayDays`

规则（通俗版）：

- 只对“新 Extract”生效，并且只在初始化阶段用一次（避免你以后点一次优先级又被继续往后拖）。
- 找到父 Topic，然后统计：**同一天、同一父 Topic 下，比我更早创建的兄弟子块有几个**（记为 `index`）。
- 每个 `index` 增加一点“排队延迟”：
  - `stepDays = clamp(0.15, 0.5, baseIntervalDays * 0.2)`
  - `queueDelayDays = index * stepDays`

为什么能缓解压力？

- 10 个 Extract：最后一个大概会比第一个多推迟约 `4.5` 天（每个 0.5 天时）。
- 20 个 Extract：最后一个可能多推迟约 `9.5` 天。

> 注意：为了确保“快速连续创建”时父 Topic 的 `children` 列表是最新的，计算排队延迟前会强制刷新父块缓存（否则可能导致所有 Extract 都算出 `index=0`，从而再次扎堆）。

### 4.4 最终间隔与到期时间

最终会写回：

- `ir.intervalDays = clamp(1..max, dispersedIntervalDays)`
  - Extract 最大 30 天
  - Topic 最大 60 天
- `ir.due = now + ir.intervalDays`

## 5. “你做了 10 个 Extract”时的预期结果（用于验收）

假设：

- 今天是 `2/2`（举例）
- 这批 Extract 都继承到 `ir.priority=50`
- Extract 基础间隔 `base≈4` 天

那么第 N 个（N 从 1 到 10）Extract 的第一次间隔大致为：

- `base (4d) + 随机往后(0~2d) + 排队延迟((N-1)*0.5d)`

得到区间：

- 第 1 个：`4.0~6.0` 天后（约 `2/6~2/8`）
- 第 5 个：`6.0~8.0` 天后（约 `2/8~2/10`）
- 第 10 个：`8.5~10.5` 天后（约 `2/10~2/12`）

这就是我们希望看到的“自然铺开到一周左右”。

如果你仍看到所有 Extract 都集中在 `2/6~2/8` 附近，说明“排队延迟没有生效”，请看下一节调试清单。

## 6. 调试清单：为什么还会堆积？

### 6.1 最常见：排队延迟算出来是 0

可能原因：

- 父 Topic 的 `children` 列表拿到的是旧快照（缓存/刷新时机问题）
- 新创建的 Extract 块拿不到 `created` 时间（无法判断“同一天/先后顺序”）
- 创建流程没走到 `updatePriority`（理论上 `createExtract` / `autoMarkAsExtract` 都会调用）

快速定位建议：

1) 在 UI 上看每个 Extract 的 `间隔` 是否从 4.x～6.x 持续上升到 8.x～10.x（如果全部都在 4～6，排队延迟大概率没生效）
2) 临时在 `computeNewExtractQueueDelayDays` 里加一行 `console.log`，打印：
   - `blockId`
   - `parentId`
   - `created`
   - `index`
   - `stepDays`
   - `queueDelayDays`
3) 重点检查父 Topic 的 `children.length` 是否在快速创建时持续增长

### 6.2 你看到“乱序”是正常的

我们是“随机铺开”，不是严格平均分配。只要不挤在 1～2 天窗口里就达标。

### 6.3 每日上限（dailyLimit）不会自动帮你改排期

`buildIRQueue` 主要负责“挑今天展示什么”，不会自动重排所有卡。

如果你希望“当天太多就自动推迟低优先级”，那属于 Auto-Postpone 的增强方向，可在后续按需增加（目前已有“溢出推后”按钮能力作为人工触发的版本）。

## 7. 相关文件索引（按排查顺序）

- 入口（创建 Extract）：
  - `src/srs/extractUtils.ts#createExtract`（选中内容摘录）
  - `src/srs/incrementalReadingAutoMark.ts#autoMarkAsExtract`（Topic 下子块自动标记）
- 排期写入（单一真相）：
  - `src/srs/incrementalReadingStorage.ts`
- 分散逻辑：
  - `src/srs/incrementalReadingDispersal.ts`
- 今日推送（队列）：
  - `src/srs/incrementalReadingCollector.ts`

