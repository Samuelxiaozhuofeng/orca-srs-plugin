# 渐进阅读模块

## 功能概述

渐进阅读模块用于管理 Topic（主题）与 Extract（摘录）两类块的阅读节奏，提供独立于 SRS 复习的阅读面板与调度逻辑。支持优先级调度、原生编辑器、面包屑导航与完整操作（已读、靠前/靠后、推后、读完、删除）。

## 自动标签开关

自动标签功能用于在 Topic 下创建子块时，自动补齐 `#card` 标签并设置 `type=extracts`。当前默认关闭，可在命令面板中手动切换：

- 命令：`SRS: 切换渐进阅读自动标签`
- 启用时：新建子块会自动打标签并初始化 Extract
- 关闭时：新建子块不做自动标记

说明：默认值由插件设置项 `enableAutoExtractMark` 控制；也可以在「渐进阅读管理面板」顶部的「队列设置」中直接修改（与插件 Settings 面板同步）。

## 数据模型

渐进阅读状态存储在 Block Properties 中，字段如下：

- `ir.priority`：优先级，0-100（默认 50，数值越大越优先）
- `ir.lastRead`：上次阅读时间（Date 或 null）
- `ir.readCount`：累计阅读次数
- `ir.due`：下次到期时间（Date）
- `ir.intervalDays`：当前间隔（天，可为小数），用于计算下一次 `ir.due`
- `ir.postponeCount`：累计推后次数（手动推后 + 溢出推后）
- `ir.stage`：漏斗阶段（如 `topic.preview` / `extract.raw`）
- `ir.lastAction`：最近一次动作（如 `read` / `postpone` / `autoPostpone` / `priority`）
- `ir.position`：Topic 队列位置（数值越小越靠前）
- `ir.resumeBlockId`：继续阅读进度（下次打开卡片时自动跳转到该 blockId）

标签属性补充：

- `#card.priority`：数字优先级（Number）
  - 仅用于 Orca 的标签属性面板展示/筛选
  - 插件会在写入 `ir.priority` 后主动同步该值到 `#card.priority`
  - 调度/选卡逻辑只使用 `ir.priority`，不会读取 `#card.priority`

类型定义：

```ts
export type IRState = {
  priority: number
  lastRead: Date | null
  readCount: number
  due: Date
  intervalDays: number
  postponeCount: number
  stage: string
  lastAction: string
  position: number | null
  resumeBlockId: number | null
}
```

## 调度算法

优先级调度采用单一真相：**只使用 `ir.priority(0-100)`**，并引入“间隔增长”避免材料长期高频出现。

### 1) 基础间隔（base interval）

- Topic：优先级越高越频繁（约 `14d → 2d`）
- Extract：优先级越高越频繁（约 `7d → 1d`）

实现位于：`src/srs/incrementalReadingScheduler.ts`

### 2) 到期时间（due）

- `calculateNextDue(cardType, priority, baseDate)` 会在基础间隔上加入 0–12h 抖动，减少同日堆积。

### 3) 已读后的间隔增长（intervalDays growth）

- Topic：`intervalDays *= 1.25`（上限 60 天）
- Extract：`intervalDays *= 1.35`（上限 30 天）

注意：调整优先级（`updatePriority / markAsReadWithPriority`）会把 `intervalDays` 重置为新的基础间隔，并立刻重算 `due`（基于当前时间）。

## 交互语义

- 已读：按当前优先级重算 `ir.due`，并移出当日队列
- 靠前/靠后：等同“已读 + 优先级上/下调一档”
  - Topic/Extract 均调整 `ir.priority`（默认步长 ±10，范围 0-100）
- 优先级切换（Topic 专用）：快速在 20 / 50 / 80 间循环，便于粗粒度调整
- 推后：把当前卡片推迟到未来几天（由 `ir.priority` 与 cardType 决定随机区间），并写回 `ir.due/ir.intervalDays/ir.postponeCount/ir.lastAction`
- 读完：移除 `#card` 标签并清空 SRS/IR 状态（`srs.*` + `ir.*`）
- `ir_record`（斜杠命令）：记录当前阅读进度（`ir.resumeBlockId`），下次该卡片进入阅读面板时自动跳转继续阅读

## API 参考

### `loadIRState(blockId)`
读取渐进阅读状态，缺失字段自动使用默认值。

### `saveIRState(blockId, state)`
写入 `ir.*` 属性。

### `ensureIRState(blockId)`
确保状态初始化（用于旧块自动补齐字段）。

### `markAsRead(blockId)`
标记已读，更新 `ir.lastRead`、`ir.readCount` 与 `ir.due`。

### `markAsReadWithPriority(blockId, newPriority)`
标记已读并更新 `ir.priority`，基于当前时间重算 `ir.due`。

### `updatePriority(blockId, newPriority)`
更新优先级并立即重算 `ir.due`（基于当前时间）。

### `updateResumeBlockId(blockId, resumeBlockId)`
仅更新阅读进度（`ir.resumeBlockId`），不改变其它状态。

### `postpone(blockId)`
推后当前卡片：按优先级档位自动推迟到未来几天，并更新 `ir.due/ir.intervalDays/ir.postponeCount/ir.lastAction`。

### `deleteIRState(blockId)`
删除所有 `ir.*` 属性。

### `completeIRCard(blockId)`
移除 `#card` 标签并清理 SRS/IR 状态（用于“读完”）。

## 收集与队列

收集器只返回 `cardType` 为 `topic` 或 `extracts` 的块，并且满足以下条件：

- `ir.due` 在今天（含）之前（按天边界判断）

队列构建规则：

- Topic：按 `priority` 降序，其次 `due`，再按 `position`
- Extract：按 `due` 升序，其次 `priority` 降序
- `topicQuotaPercent`：Topic 的目标占比（默认 20%）
- `dailyLimit`：每日推送上限；启用后会对候选集合截断
- 逾期 Extract 优先：在 `dailyLimit` 模式下，会先把“已逾期”的 Extract 放到队列最前面，再按配额填充剩余槽位
- `enableAutoDefer`：启用溢出推后按钮；当到期卡超过每日上限时，允许“一键把溢出推后”（打开面板只展示，不会自动改排期）

提示：以上 3 个队列相关设置（`topicQuotaPercent` / `dailyLimit` / `enableAutoDefer`）可在「渐进阅读管理面板」的「队列设置」中快速配置。

## UI 组件

### `IncrementalReadingSessionRenderer`
块渲染器入口，负责加载队列并渲染会话 UI。

### `IncrementalReadingSessionDemo`
阅读面板主体，提供：

- 原生块编辑器（`orca.components.Block`）
- 面包屑导航
- 操作区（已读、靠前/靠后、跳过、读完、删除）
- Topic 额外操作：优先级切换（仅影响 `ir.priority`）

### `IncrementalReadingBreadcrumb`
向上查找最近的 Topic，显示格式：

```
Topic Title > Extract Title
```

点击可跳转到对应块，Shift+点击在侧面板打开。

## 管理面板

管理面板用于全局查看渐进阅读卡片的统计与排期，并支持批量操作。

### 入口

- 命令：`orca-srs.openIRManager`（在当前面板打开管理面板）

### 统计面板

- 总卡片数
- 新卡数
- 到期卡数（已逾期 + 今天，红色/橙色大字号）
- 未来 7 天到期数（黄色高亮）

### 排期分组（视觉优先级从高到低）

分组顺序：

1. 已逾期（红色边框 + 红色标签，默认展开）
2. 今天（橙色边框 + 橙色标签，默认展开）
3. 明天（黄色高亮）
4. 未来7天（正常显示）
5. 新卡（蓝色标签）
6. 7天后（灰色文字，默认折叠）

分组边界使用自然日 00:00 作为基准。

### 侧面板跳转

- 点击卡片标题始终在侧面板打开对应块，主面板不变
- 支持在主面板继续工作，同时在侧面板查看与编辑卡片

### 单卡操作

- 在“明天 / 未来7天 / 新卡 / 7天后”分组的卡片右侧提供「提前学」按钮：将该卡 `ir.due` 提前到今天，并打开「渐进阅读会话面板」优先展示该卡（即使开启每日上限也保证进队列）

### 批量操作

- 支持多选卡片
- 批量调整优先级（0-100）
- 操作完成后自动刷新列表
- 部分失败会提示数量与详情入口

### 迁移说明

当前实现以 `ir.priority(0-100)` 为单一真相；不再使用“高/中/低”三档优先级。

## 使用流程

1. 创建 Topic 块并标记 `#card`，`type=topic`
2. 在 Topic 下创建子块，自动标记为 `extracts`
3. 通过“渐进阅读”入口打开阅读面板
4. 在面板中阅读、编辑、已读/靠前/靠后/读完

## 关键文件

- `src/srs/incrementalReadingStorage.ts`
- `src/srs/incrementalReadingScheduler.ts`
- `src/srs/incrementalReadingCollector.ts`
- `src/srs/incrementalReadingManagerUtils.ts`
- `src/components/IncrementalReadingSessionRenderer.tsx`
- `src/components/IncrementalReadingSessionDemo.tsx`
- `src/components/IncrementalReadingBreadcrumb.tsx`
- `src/components/IncrementalReadingManagerPanel.tsx`
- `src/components/IRStatistics.tsx`
- `src/components/IRCardList.tsx`
- `src/components/IRBulkActionBar.tsx`
